define(["require","exports","json","util","log"],function(e,t,r,n,a){function o(e){return e<10?"0"+e:e}function s(e,t){if("lotus.domino.local.DateTime"==typeof t||t instanceof java.util.Date){var r=t instanceof java.util.Date?t:t.toJavaDate();return r.getUTCFullYear()+"-"+o(r.getUTCMonth()+1)+"-"+o(r.getUTCDate())+"T"+o(r.getUTCHours())+":"+o(r.getUTCMinutes())+":"+o(r.getUTCSeconds())+"Z"}return t}function i(e,t){var r={};for(var a in t)r[a]=n.vector2array(e.getItemValue(a)),r[a].length<=1&&(r[a]=0==r[a].length?"":r[a][0]);return r}function l(e,t,n,a,o,l,u,c){try{e.setPreferJavaDates(!0);var g=[],f={},p=e.getColumnValues(),h=!0;if(a=a||e.getDocument().getParentDatabase().getFilePath(),t){for(var v=0;v<p.size();v++)u&&t[v]==c&&(h=(r.stringify(p.get(v))+"").toLowerCase().indexOf(u)!=-1),f[t[v]]=p.get(v);if(!h)return null;if(f["@unid"]=e.getUniversalID(),f["@href"]="/"+a+"/api/data/collections/name/0/unid"+e.getUniversalID(),f["@position"]=e.getPosition("."),f["@noteid"]=e.getNoteID(),f["@siblings"]=e.getSiblingCount(),f["@ftscore"]=e.getFTSearchScore(),o){var m=e.getDocument();try{f["@parent"]=i(m.getParentDatabase().getDocumentByUNID(m.getParentDocumentUNID()),o)}catch(e){print(e),f["@parent"]={error:e+""}}}if(l){var d={};for(var C in l){var D=l[C];try{d[C]=D.instance(e,n,t)}catch(e){d[C]=e+""}}f["@computed"]=d}return r.stringify(f,s)}for(var v=0;v<p.size();v++)u&&t[v]==c&&(h=(r.stringify(p.get(v))+"").toLowerCase().indexOf(u)!=-1),g.push(p.get(v));if(!h)return null;if(g.push(e.getUniversalID()),g.push("/"+a+"/api/data/collections/name/0/unid"+e.getUniversalID()),g.push(e.getPosition(".")),g.push(e.getNoteID()),g.push(e.getSiblingCount()),g.push(e.getFTSearchScore()),o){var m=e.getDocument();try{g.push(i(m.getParentDatabase().getDocumentByUNID(m.getParentDocumentUNID()),o))}catch(e){g.push({})}}return r.stringify(g,s)}catch(e){return print(e),r.stringify({error:e.toString()})}}function u(){var e=facesContext.getExternalContext().getRequestHeaderMap(),t=facesContext.getExternalContext().getResponse(),r=t.getOutputStream();t.setContentType("application/json; charset=UTF-8"),t.setHeader("Cache-Control","no-cache"),c(param,r,e,t),facesContext.responseComplete(),r.close()}function c(t,r,n,o){var s=session.getDatabase(session.getCurrentDatabase().getServer(),t.db);if(!s.isOpen())return{error:"Cannot open target db: "+t.db};var i,u,c=s.getView(t.view),g=0,f=(new Array,null),p={},h=n["Range"]||n["X-Range"],v=s.getFilePath(),m=null,d=null;h&&(h=h.match(/(\w+)[ =](\d+)-(\d+)\/?(\d*)/),h&&(h[2]=""==h[2]?null:parseInt(h[2])+1,h[3]=""==h[3]?null:parseInt(h[3])+2,h[4]=""==h[4]?null:parseInt(h[4])));var C=null===h||null===h[2]?t.start||1:h[2],D=null===h||null===h[3]||null===h[2]?t.count||50:h[3]-h[2],y=t.expandlevel?parseInt(t.expandlevel):0;if(t.search&&a.warn("expandlevel and search are inefficient used simultaneously."),y>1&&(y=0,a.warn("expandlevel can be 0 or 1")),t.parentColumns){f={};for(var I=t.parentColumns.split(","),w=0;w<I.length;w++)f[I[w]]=!0}if(t.computedColumns)for(var I=fromJson(t.computedColumns),w=0;w<I.length;w++){var x=I[w];if(x.id&&x.lib&&x.proc){x.instance=null;try{x.instance=e(x.lib)[x.proc]}catch(e){x.error=e.toString()}p[x.id]=x}}y?(u=c.createViewNavMaxLevel(0),g=u.getCount()):g=t.sortcolumn?t.search?c.FTSearchSorted(t.search,500,t.sortcolumn,!t.sortorder||"descending"!=t.sortorder,!1,!1,!1):c.getEntryCount():t.search?c.FTSearch(t.search,500):c.getEntryCount(),m=t.search?t.search.toLowerCase():null,d=t.searchIn?t.searchIn.toLowerCase():null,D=Math.min(g,D)-1,o.setHeader("Content-Range","items "+(C-1)+"-"+(C+D-1)+"/"+g);var U;y||(U=c.getAllEntries());for(var S=c.getColumns(),T=[],b={},w=0;w<S.size();w++)T.push(S.get(w).getItemName()),b[S.get(w).getItemName()]=w;var N=new java.io.OutputStreamWriter(r,"UTF-8");N.write("[");var P=!1;if(g>0){if(y)var F=u.getNth(parseInt(C));else var F=U.getNthEntry(parseInt(C));var E=l(F,T,b,v,f,p,m,d);E&&N.write(E);for(var w=0;w<D&&(i=y?u.getNext(F):U.getNextEntry(F),F.recycle(),F=i,E&&(P=!0),E=l(F,T,b,v,f,p,m,d),E&&(P&&N.write(", "),N.write(E)),w%50==0&&N.flush(),F);w++);}N.write("]"),N.flush(),N.close()}t.process=u,t.stream=c});